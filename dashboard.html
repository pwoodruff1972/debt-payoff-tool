<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Dashboard | Debt Payoff Planner</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f4f7f6; margin: 0; color: #333; }
        .container { max-width: 960px; margin: auto; padding: 1em 2em 2em 2em; }
        .header { background-color: #fff; padding: 1rem 2rem; border-bottom: 1px solid #e9ecef; margin-bottom: 1em; }
        .header a { text-decoration: none; font-weight: 600; color: #007bff; }
        h1, h2, h3, h4 { color: #111; }
        h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 2em; }
        .card { background-color: #fff; border: 1px solid #dee2e6; padding: 20px; border-radius: 8px; margin-bottom: 2em; }
        .card h3 { margin-top: 0; }
        .charts-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; align-items: center; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .metric-card { background-color: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center; }
        .metric-card-title { font-size: 0.9rem; font-weight: 600; color: #6c757d; margin-bottom: 0.5rem; }
        .metric-card-value { font-size: 1.5rem; font-weight: bold; color: #007bff; }
        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .insight-card { background-color: #f8f9fa; padding: 1.5rem; border-radius: 8px; }
        .insight-card h4 { margin-top: 0; border-bottom: 1px solid #e9ecef; padding-bottom: 0.5rem; }
        .insight-card ul { list-style-type: none; padding: 0; margin: 0; }
        .insight-card li { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.95rem; }
        .insight-card li span:first-child { font-weight: 600; }

        @media (max-width: 768px) { 
            .charts-grid { grid-template-columns: 1fr; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R12C8R93T1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-R12C8R93T1');
    </script>
</head>
<body>

    <header class="header">
        <a href="app.html">&larr; Back to Main Tool</a>
    </header>

    <div class="container">
        <h1>Pro Dashboard</h1>
        
        <div id="key-metrics" class="metrics-grid">
            <!-- Metric cards will be generated by JavaScript -->
        </div>
        
        <div class="card">
            <h3>Debt Insights (Current)</h3>
            <div id="debt-insights" class="insights-grid">
                <!-- Insights will be generated by JavaScript -->
            </div>
        </div>

        <div class="card">
            <h3>Visual Overview</h3>
            <div id="dashboard-charts" class="charts-grid">
                <div class="chart-container">
                    <h4>Debt Breakdown (Current)</h4>
                    <canvas id="debtPieChart"></canvas>
                </div>
                <div class="chart-container" id="line-chart-container" style="display: none;">
                    <h4>Payoff Projection</h4>
                    <canvas id="debtLineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    window.addEventListener('DOMContentLoaded', (event) => {
        const keyMetricsDiv = document.getElementById('key-metrics');
        const debtInsightsDiv = document.getElementById('debt-insights');
        
        let debts = JSON.parse(localStorage.getItem('debts')) || [];
        let fullPlanDetails = JSON.parse(localStorage.getItem('fullPlanDetails')) || [];
        let paidMonths = JSON.parse(localStorage.getItem('paidMonths')) || [];
        let paidDebtIds = JSON.parse(localStorage.getItem('paidDebtIds')) || [];
        
        let pieChartInstance = null;
        let lineChartInstance = null;

        function getCurrentDebtStates() {
            let currentBalances = {};
            debts.forEach(d => {
                if (!paidDebtIds.includes(d.id)) {
                    currentBalances[d.name] = { ...d };
                }
            });

            const lastPaidMonth = paidMonths.length > 0 ? Math.max(...paidMonths) : 0;
            if (lastPaidMonth > 0) {
                const lastMonthDetails = fullPlanDetails[lastPaidMonth - 1];
                if (lastMonthDetails) {
                    lastMonthDetails.payments.forEach(p => {
                        if (currentBalances[p.name]) {
                            currentBalances[p.name].balance = p.newBalance;
                        }
                    });
                }
            }
            return Object.values(currentBalances).filter(d => d.balance > 0);
        }

        function initializeDashboard() {
            if (debts.length === 0 || fullPlanDetails.length === 0) {
                document.body.innerHTML = `<div class="container" style="text-align: center;"><h1>No Plan Found</h1><p>Please go back to the main tool and calculate a payoff plan to see your dashboard.</p><a href="app.html" style="text-decoration: none; color: #007bff; font-weight: 600;">&larr; Back to Tool</a></div>`;
                return;
            }
            
            displayLiveDashboardData();
        }

        function displayLiveDashboardData() {
            const lastPaidMonth = paidMonths.length > 0 ? Math.max(...paidMonths) : 0;
            const lastMonthDetails = fullPlanDetails[lastPaidMonth - 1] || null;
            const totalDebtAtStart = debts.reduce((sum, d) => sum + d.balance, 0);
            const currentDebtRemaining = lastMonthDetails ? lastMonthDetails.remainingBalance : totalDebtAtStart;
            const monthsRemaining = fullPlanDetails.length - lastPaidMonth;
            const debtFreeDate = new Date();
            debtFreeDate.setMonth(debtFreeDate.getMonth() + monthsRemaining);
            const totalInterestInPlan = fullPlanDetails.reduce((sum, row) => sum + row.totalInterest, 0);

            keyMetricsDiv.innerHTML = `
                <div class="metric-card">
                    <div class="metric-card-title">Debt-Free Date</div>
                    <div class="metric-card-value">${debtFreeDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-title">Debt Remaining</div>
                    <div class="metric-card-value">$${currentDebtRemaining.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-title">Months Remaining</div>
                    <div class="metric-card-value">${monthsRemaining}</div>
                </div>`;

            const currentDebtObjects = getCurrentDebtStates();
            const totalPrincipal = currentDebtObjects.reduce((sum, d) => sum + d.balance, 0);
            const weightedTotal = currentDebtObjects.reduce((sum, d) => sum + (d.balance * d.apr), 0);
            const weightedAvgApr = totalPrincipal > 0 ? (weightedTotal / totalPrincipal) : 0;
            const largestDebts = [...currentDebtObjects].sort((a, b) => b.balance - a.balance).slice(0, 3);
            const mostExpensiveDebts = [...currentDebtObjects].sort((a, b) => b.apr - a.apr).slice(0, 3);
            
            debtInsightsDiv.innerHTML = `
                <div class="insight-card">
                    <h4>Financial Snapshot</h4>
                    <ul>
                        <li><span>Weighted Avg. APR</span> <span>${weightedAvgApr.toFixed(2)}%</span></li>
                        <li><span>Total Principal</span> <span>$${totalPrincipal.toFixed(2)}</span></li>
                        <li><span>Total Interest in Plan</span> <span>$${totalInterestInPlan.toFixed(2)}</span></li>
                    </ul>
                </div>
                <div class="insight-card">
                    <h4>Largest Debts (by Balance)</h4>
                    <ul id="largest-debts-list"></ul>
                </div>
                <div class="insight-card">
                    <h4>Most Expensive Debts (by APR)</h4>
                    <ul id="expensive-debts-list"></ul>
                </div>
            `;
            const largestList = document.getElementById('largest-debts-list');
            largestDebts.forEach(d => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${d.name}</span> <span>$${d.balance.toFixed(2)}</span>`;
                largestList.appendChild(li);
            });
            const expensiveList = document.getElementById('expensive-debts-list');
            mostExpensiveDebts.forEach(d => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${d.name}</span> <span>${d.apr.toFixed(2)}%</span>`;
                expensiveList.appendChild(li);
            });

            const pieChartCanvas = document.getElementById('debtPieChart');
            if (pieChartInstance) pieChartInstance.destroy();
            const pieData = currentDebtObjects.map(d => d.balance);
            const pieLabels = currentDebtObjects.map(d => d.name);
            pieChartInstance = new Chart(pieChartCanvas, { type: 'pie', data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: ['#007bff', '#dc3545', '#ffc107', '#28a745', '#6f42c1', '#fd7e14', '#20c997'], }] }, options: { responsive: true, maintainAspectRatio: true } });
            
            const lineChartCanvas = document.getElementById('debtLineChart');
            const lineChartContainer = document.getElementById('line-chart-container');
            if (lineChartInstance) lineChartInstance.destroy();
            if (fullPlanDetails.length > 0) { 
                lineChartContainer.style.display = 'block'; 
                const lineLabels = fullPlanDetails.map(row => `M${row.month}`); 
                lineLabels.unshift("Start"); 
                const lineData = fullPlanDetails.map(row => row.remainingBalance); 
                const startBalance = debts.reduce((sum, d) => sum + d.balance, 0); 
                lineData.unshift(startBalance); 
                lineChartInstance = new Chart(lineChartCanvas, { type: 'line', data: { labels: lineLabels, datasets: [{ label: 'Remaining Balance', data: lineData, borderColor: '#007bff', backgroundColor: 'rgba(0, 123, 255, 0.1)', fill: true, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: true } }); 
            }
        }
        
        initializeDashboard();
    });
    </script>
</body>
</html>

