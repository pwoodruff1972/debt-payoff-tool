<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Payoff Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f4f7f6; margin: 0; color: #333; }
        .container { max-width: 800px; margin: auto; padding: 1em 2em 2em 2em; }
        .header { background-color: #fff; padding: 1rem 2rem; border-bottom: 1px solid #e9ecef; margin-bottom: 1em; }
        .header a { text-decoration: none; font-weight: 600; color: #007bff; }
        h1, h2, h3 { color: #111; }
        h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 2em; }
        input[type="text"], input[type="number"] { width: 95%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 16px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        ul { list-style-type: none; padding: 0; }
        li { background: #e9ecef; padding: 15px; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease-in-out; }
        .delete-btn, .edit-btn { padding: 5px 10px; font-size: 12px; margin-left: 5px;}
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
        .edit-btn { background-color: #6c757d; }
        .edit-btn:hover { background-color: #5a6268; }
        .card { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 2em; border: 1px solid #dee2e6; }
        .card h3 { margin-top: 0; }
        .strategy-selector label { margin-right: 20px; cursor: pointer; font-weight: 500; }
        .strategy-description { font-size: 14px; color: #666; padding-left: 22px; margin-bottom: 10px; margin-top: 2px; }
        #results, #scenario-planner { margin-top: 2em; background-color: #e6f7ff; border: 1px solid #91d5ff; padding: 20px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { text-align: left; padding: 12px 8px; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        #min-payment-guidance { display: block; margin-top: -5px; margin-bottom: 15px; font-size: 14px; color: #555; }
        #plan-tbody tr { cursor: pointer; }
        #plan-tbody tr:hover { background-color: #d1ecf1; }
        #plan-tbody tr.paid-row { background-color: #d4edda; color: #555; text-decoration: line-through; }
        #plan-tbody tr.paid-row:hover { background-color: #c3e6cb; }
        #month-details { margin-top: 1.5em; padding: 15px; background-color: #fff; border: 1px solid #ccc; border-radius: 8px; }
        #month-details ul { padding-left: 0; list-style-type: none; }
        #month-details li { background: none; padding: 8px 0; margin-bottom: 0; display: flex; align-items: center; }
        #month-details input[type="checkbox"] { margin-right: 12px; transform: scale(1.2); cursor: pointer; }
        #month-details label { cursor: pointer; }
        .data-management button { background-color: #6c757d; margin-right: 10px; }
        .data-management button:hover { background-color: #5a6268; }
        .toggle-paid-btn { background-color: #28a745; font-size: 12px; padding: 4px 8px; cursor: pointer; }
        .toggle-paid-btn.unmark { background-color: #ffc107; color: #333; }
        #upgrade-card { border: 2px solid #007bff; background-color: #f0f8ff; }
        #upgrade-card h3 { color: #007bff; }
        .pro-label { font-size: 0.8em; background-color: #007bff; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }
        #license-key-input { width: calc(100% - 250px); margin-right: 10px; display: inline-block; }
        #unlock-btn { width: 110px; display: inline-block; }
        .buy-button { background-color: #28a745; display: inline-block; text-align: center; text-decoration: none; color: white !important; padding: 10px 15px; border-radius: 4px; font-size: 16px; margin-left: 10px;}
        .buy-button:hover { background-color: #218838; }
        #dashboard-card { display: none; }
        .chart-container { width: 100%; margin-bottom: 2rem; }
        .charts-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; align-items: center; }
        .mark-paid-btn { cursor: pointer; font-size: 24px; color: #aaa; margin-right: 15px; user-select: none; }
        .debt-item.paid { background-color: #e2e6ea; color: #6c757d; }
        .debt-item.paid .debt-details { text-decoration: line-through; }
        .debt-item.paid .mark-paid-btn { color: #28a745; font-weight: bold; }
        .paid-badge { font-size: 0.8em; background-color: #28a745; color: white; padding: 3px 6px; border-radius: 4px; margin-left: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background-color: #fff; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; }
        .modal-content h3 { margin-top: 0; }
        .modal-buttons { margin-top: 1rem; text-align: right; }
        .modal-buttons button { margin-left: 10px; }
        .scenario-grid { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end; }

        @media (max-width: 768px) { .charts-grid, .scenario-grid { grid-template-columns: 1fr; } #license-key-input { width: 100%; margin-bottom: 10px; } #unlock-btn, .buy-button { width: 100%; margin-left: 0; } }
    </style>
</head>
<body>

    <header class="header">
        <a href="index.html">&larr; Back to Homepage</a>
    </header>

    <div class="container">
        <h1>Debt Payoff Tool</h1>
        
        <div id="upgrade-card" class="card">
            <h3>Upgrade to Pro</h3>
            <p id="upgrade-message" style="font-size: 14px; color: #555; margin-top: 0;">Unlock powerful features to accelerate your debt-free journey:</p>
            <ul>
                <li>✅ Add Unlimited Debts</li>
                <li>✅ Access visual charts and graphs</li>
                <li>✅ "What If" Scenario Planner</li>
            </ul>
            <div>
                <input type="text" id="license-key-input" placeholder="Enter License Key">
                <button id="unlock-btn">Unlock</button>
                <a href="https://woodruffian2.gumroad.com/l/debt-payoff-planner-pro" class="buy-button" target="_blank">Buy Pro</a>
            </div>
        </div>

        <h2>1. Add Your Debts</h2>
        <form id="debt-form" class="card">
            <input type="text" id="debt-name" placeholder="Debt Name/Due Date (e.g., Visa/15th)" required>
            <input type="number" id="debt-balance" placeholder="Current Balance ($)" required step="0.01">
            <input type="number" id="debt-apr" placeholder="Interest Rate (APR %)" required step="0.01">
            <input type="number" id="debt-min-payment" placeholder="Minimum Monthly Payment ($)" required step="0.01">
            <button type="submit">Add Debt</button>
        </form>

        <div class="data-management card">
            <h3>Data Management</h3>
            <p style="font-size: 14px; color: #555; margin-top: 0;">Save your debt list to a file as a backup, or load a previous backup from a file.</p>
            <button id="export-btn">Export to File</button>
            <button id="import-btn">Import from File</button>
            <input type="file" id="import-file" accept=".json" style="display: none;">
        </div>

        <h2>2. Your Debts List <small id="paid-off-instruction" style="font-weight: normal; font-size: 0.7em; color: #555;">(Click the ✓ to mark a debt as paid off)</small></h2>
        <ul id="debt-list"></ul>
        
        <div id="dashboard-container">
            <h2>Visual Dashboard <span class="pro-label">Pro</span></h2>
            <div id="dashboard-card" class="card"></div>
        </div>

        <h2>3. Create a Payoff Plan</h2>
        <div class="strategy-selector card">
            <h3>Choose Strategy</h3>
            <div>
                <label><input type="radio" name="strategy" value="snowball" checked> Debt Snowball</label>
                <div class="strategy-description">Focuses on paying off the smallest debts first to build momentum.</div>
            </div>
            <div>
                <label id="avalanche-label"><input type="radio" name="strategy" value="avalanche" id="avalanche-radio"> Debt Avalanche</label>
                <div class="strategy-description">Focuses on paying off the highest interest rate debts first to save the most money.</div>
            </div>
        </div>

        <div class="calculator card">
            <h3>Set Your Budget</h3>
            <label for="total-payment">Total Monthly Payment ($)</label>
            <input type="number" id="total-payment" placeholder="e.g., 1500">
            <small id="min-payment-guidance"></small>
            <button id="calculate-btn">Calculate Plan</button>
        </div>

        <div id="results" style="display: none;">
            <h3>Your Payoff Plan <small>(Click a row for details)</small></h3>
            <p id="results-summary"></p>
            <table>
                <thead>
                    <tr><th>Month</th><th>Total Payment</th><th>Interest Paid</th><th>Remaining Balance</th><th>Status</th></tr>
                </thead>
                <tbody id="plan-tbody"></tbody>
            </table>
            <div id="month-details" style="display: none;"></div>
        </div>
        
        <div id="scenario-planner" class="card" style="display: none;">
            <h3>"What If" Scenario Planner <span class="pro-label">Pro</span></h3>
            <div class="scenario-grid">
                <div>
                    <label for="extra-payment">Extra Monthly Payment</label>
                    <input type="number" id="extra-payment" placeholder="$100">
                </div>
                <div>
                    <label for="lump-sum">One-Time Lump Sum</label>
                    <input type="number" id="lump-sum" placeholder="$1000">
                </div>
                <div>
                    <label for="lump-sum-month">Lump Sum Month (Month # to apply)</label>
                    <input type="number" id="lump-sum-month" placeholder="e.g., 6" min="1">
                </div>
                <div>
                    <button id="compare-btn">Compare</button>
                </div>
            </div>
            <div id="scenario-results" style="display: none; margin-top: 1rem;"></div>
        </div>
    </div>
    
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Edit Debt</h3>
            <form id="edit-debt-form">
                <input type="hidden" id="edit-debt-id">
                <label for="edit-debt-name">Debt Name/Due Date</label>
                <input type="text" id="edit-debt-name" placeholder="Debt Name/Due Date (e.g., Visa/15th)" required>
                <label for="edit-debt-balance">Current Balance ($)</label>
                <input type="number" id="edit-debt-balance" placeholder="Current Balance ($)" required step="0.01">
                <label for="edit-debt-apr">Interest Rate (APR %)</label>
                <input type="number" id="edit-debt-apr" placeholder="Interest Rate (APR %)" required step="0.01">
                <label for="edit-debt-min-payment">Minimum Monthly Payment ($)</label>
                <input type="number" id="edit-debt-min-payment" placeholder="Minimum Monthly Payment ($)" required step="0.01">
                <div class="modal-buttons">
                    <button type="button" id="cancel-edit-btn" class="edit-btn">Cancel</button>
                    <button type="submit" id="save-edit-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    window.addEventListener('DOMContentLoaded', (event) => {
        const debtForm = document.getElementById('debt-form');
        const debtList = document.getElementById('debt-list');
        const strategyRadios = document.querySelectorAll('input[name="strategy"]');
        const totalPaymentInput = document.getElementById('total-payment');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsDiv = document.getElementById('results');
        const resultsSummary = document.getElementById('results-summary');
        const planTbody = document.getElementById('plan-tbody');
        const minPaymentGuidance = document.getElementById('min-payment-guidance');
        const monthDetailsDiv = document.getElementById('month-details');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFileInput = document.getElementById('import-file');
        const upgradeCard = document.getElementById('upgrade-card');
        const licenseKeyInput = document.getElementById('license-key-input');
        const unlockBtn = document.getElementById('unlock-btn');
        const avalancheRadio = document.getElementById('avalanche-radio');
        const dashboardContainer = document.getElementById('dashboard-container');
        const dashboardCard = document.getElementById('dashboard-card');
        const upgradeMessage = document.getElementById('upgrade-message');
        const editModal = document.getElementById('edit-modal');
        const editDebtForm = document.getElementById('edit-debt-form');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const paidOffInstruction = document.getElementById('paid-off-instruction');
        const scenarioPlanner = document.getElementById('scenario-planner');
        const compareBtn = document.getElementById('compare-btn');
        const scenarioResults = document.getElementById('scenario-results');

        let debts = JSON.parse(localStorage.getItem('debts')) || [];
        let fullPlanDetails = [];
        let paidMonths = JSON.parse(localStorage.getItem('paidMonths')) || [];
        let paidDebtIds = JSON.parse(localStorage.getItem('paidDebtIds')) || [];
        let pieChartInstance = null;
        let lineChartInstance = null;
        let paidProgress = JSON.parse(localStorage.getItem('paidProgress')) || {};

        const PRO_KEY = "PRO-2025";
        const FRIEND_KEY = "FRIEND-OF-PATRICK";
        
        function isPro() {
            const key = localStorage.getItem('debtToolProKey');
            if (!key) return false;
            if (key === PRO_KEY || key === FRIEND_KEY) return true;
            const gumroadKeyRegex = /^[A-Z0-9]{8}-[A-Z0-9]{8}-[A-Z0-9]{8}-[A-Z0-9]{8}$/i;
            if (!gumroadKeyRegex.test(key)) return false;
            const unlockDate = localStorage.getItem('proUnlockDate');
            if (!unlockDate) { localStorage.setItem('proUnlockDate', Date.now()); return true; }
            return (Date.now() - parseInt(unlockDate, 10)) / (1000 * 60 * 60 * 24) < 366;
        }
        
        function unlockPro() { 
            const newKey = licenseKeyInput.value.trim();
            const oldKey = localStorage.getItem('debtToolProKey');
            if (newKey === oldKey && !isPro()) {
                alert("This license key has expired. Please purchase a new key to renew your Pro access.");
                return;
            }
            const gumroadKeyRegex = /^[A-Z0-9]{8}-[A-Z0-9]{8}-[A-Z0-9]{8}-[A-Z0-9]{8}$/i;
            if (newKey === PRO_KEY || newKey === FRIEND_KEY) {
                localStorage.setItem('debtToolProKey', newKey);
                localStorage.removeItem('proUnlockDate');
                alert("Success! Permanent Pro access unlocked.");
            } else if (gumroadKeyRegex.test(newKey)) {
                localStorage.setItem('debtToolProKey', newKey);
                localStorage.setItem('proUnlockDate', Date.now());
                alert("Success! Pro features unlocked for one year.");
            } else {
                alert("Invalid license key.");
            }
            updateUIForProStatus();
        }
        
        function updateUIForProStatus() { 
            const proStatus = isPro(); 
            const keyExists = !!localStorage.getItem('debtToolProKey');
            
            paidOffInstruction.style.display = 'inline';

            if (proStatus) { 
                upgradeCard.style.display = 'none'; 
                dashboardContainer.style.display = 'block'; 
            } else { 
                upgradeCard.style.display = 'block'; 
                dashboardContainer.style.display = 'block'; 
                if (keyExists && upgradeMessage) { 
                    upgradeCard.querySelector('h3').textContent = "Your Pro License Has Expired"; 
                    upgradeMessage.textContent = "Please purchase a new license to continue using Pro features."; 
                } 
            } 
            renderCharts(); 
            renderDebts(); 
        }

        debtForm.addEventListener('submit', addDebt);
        debtList.addEventListener('click', handleListClick);
        strategyRadios.forEach(radio => renderDebts());
        calculateBtn.addEventListener('click', () => calculatePlan());
        planTbody.addEventListener('click', handlePlanClick);
        exportBtn.addEventListener('click', exportData);
        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', importData);
        unlockBtn.addEventListener('click', unlockPro);
        monthDetailsDiv.addEventListener('change', handlePaymentCheck);
        editDebtForm.addEventListener('submit', saveDebtChanges);
        cancelEditBtn.addEventListener('click', closeEditModal);
        editModal.addEventListener('click', (event) => { if (event.target === editModal) { closeEditModal(); } });
        compareBtn.addEventListener('click', runScenario);

        function exportData() { if (debts.length === 0) { return; } const dataToExport = { debts, paidMonths, budget: totalPaymentInput.value, proKey: localStorage.getItem('debtToolProKey'), proUnlockDate: localStorage.getItem('proUnlockDate'), paidDebtIds, paidProgress }; const dataStr = JSON.stringify(dataToExport, null, 2); const dataBlob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `my-debt-plan-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); }
        function importData(event) { const file = event.target.files[0]; if (!file) { return; } const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if (Array.isArray(importedData)) { debts = importedData; paidMonths = []; paidDebtIds = []; paidProgress = {}; totalPaymentInput.value = ''; alert("Old data format imported successfully! Your Pro status has been preserved. Please set your budget and calculate a new plan."); } else if (importedData && Array.isArray(importedData.debts)) { debts = importedData.debts; paidMonths = importedData.paidMonths || []; paidDebtIds = importedData.paidDebtIds || []; paidProgress = importedData.paidProgress || {}; totalPaymentInput.value = importedData.budget || ''; if (importedData.hasOwnProperty('proKey') && importedData.proKey !== null) { localStorage.setItem('debtToolProKey', importedData.proKey); localStorage.setItem('proUnlockDate', importedData.proUnlockDate); } alert("Data imported successfully! Click 'Calculate Plan' to see your new schedule."); } else { throw new Error("Invalid file format."); } saveAndRender(); } catch (error) { alert("Error reading file."); } }; reader.onerror = function() { alert("Failed to read the file."); }; reader.readAsText(file); importFileInput.value = ''; }
        function addDebt(event) {
            event.preventDefault();
            if (!isPro() && debts.length >= 5) { alert("The free plan is limited to 5 debts. Please upgrade to Pro for unlimited debts."); return; }
            const name = document.getElementById('debt-name').value;
            const balance = parseFloat(document.getElementById('debt-balance').value);
            const apr = parseFloat(document.getElementById('debt-apr').value);
            const minPayment = parseFloat(document.getElementById('debt-min-payment').value);
            if (!name || isNaN(balance) || isNaN(apr) || isNaN(minPayment) || balance <= 0 || apr < 0 || minPayment <= 0) { alert("Please enter valid positive numbers for all fields."); return; }
            if (debts.some(d => d.name.trim().toLowerCase() === name.trim().toLowerCase())) { alert("A debt with this name already exists. Please use a unique name."); return; }
            const newDebt = { id: Date.now(), name, balance, apr, minPayment };
            debts.push(newDebt);
            resetPlanAndProgress();
            saveAndRender();
            debtForm.reset();
        }
        function handleListClick(event) { const target = event.target; const listItem = target.closest('li'); if (!listItem) return; const id = parseInt(listItem.dataset.id); if (target.classList.contains('delete-btn')) { debts = debts.filter(debt => debt.id !== id); resetPlanAndProgress(); saveAndRender(); } if (target.classList.contains('mark-paid-btn')) { toggleDebtPaid(id); } if (target.classList.contains('edit-btn')) { openEditModal(id); } }
        function resetPlanAndProgress() { paidMonths = []; paidDebtIds = []; paidProgress = {}; localStorage.removeItem('paidMonths'); localStorage.removeItem('paidDebtIds'); localStorage.removeItem('paidProgress'); resultsDiv.style.display = 'none'; if (lineChartInstance) { lineChartInstance.destroy(); lineChartInstance = null; } renderCharts(); }
        function toggleDebtPaid(debtId) { const index = paidDebtIds.indexOf(debtId); if (index > -1) { paidDebtIds.splice(index, 1); } else { paidDebtIds.push(debtId); } localStorage.setItem('paidDebtIds', JSON.stringify(paidDebtIds)); saveAndRender(); }
        
        function openEditModal(debtId) { const debtToEdit = debts.find(debt => debt.id === debtId); if (!debtToEdit) return; document.getElementById('edit-debt-id').value = debtToEdit.id; document.getElementById('edit-debt-name').value = debtToEdit.name; document.getElementById('edit-debt-balance').value = debtToEdit.balance; document.getElementById('edit-debt-apr').value = debtToEdit.apr; document.getElementById('edit-debt-min-payment').value = debtToEdit.minPayment; editModal.style.display = 'flex'; }
        function closeEditModal() { editModal.style.display = 'none'; }
        function saveDebtChanges(event) { event.preventDefault(); const id = parseInt(document.getElementById('edit-debt-id').value); const debtToUpdate = debts.find(debt => debt.id === id); if (!debtToUpdate) return; debtToUpdate.name = document.getElementById('edit-debt-name').value; debtToUpdate.balance = parseFloat(document.getElementById('edit-debt-balance').value); debtToUpdate.apr = parseFloat(document.getElementById('edit-debt-apr').value); debtToUpdate.minPayment = parseFloat(document.getElementById('edit-debt-min-payment').value); closeEditModal(); resetPlanAndProgress(); saveAndRender(); }

        function calculatePlan(isScenario = false, scenarioParams = {}) {
            const { extraPayment = 0, lumpSum = 0, lumpSumMonth = -1 } = scenarioParams;
            const baseMonthlyPayment = parseFloat(totalPaymentInput.value);
            const totalMinimums = debts.reduce((sum, debt) => sum + debt.minPayment, 0);

            if (!isScenario && debts.length === 0) { alert("Please add at least one debt."); return; }
            if (!isScenario && (isNaN(baseMonthlyPayment) || baseMonthlyPayment <= 0)) { alert("Please enter a valid total monthly payment."); return; }
            if (!isScenario && baseMonthlyPayment < totalMinimums) { 
                alert(`Your total monthly payment must be at least $${totalMinimums.toFixed(2)} to cover your minimums.`); 
                return; 
            }
            
            const totalMonthlyPayment = baseMonthlyPayment + extraPayment;
            let simulationDebts = JSON.parse(JSON.stringify(debts));
            simulationDebts.forEach(d => { if(paidDebtIds.includes(d.id)) d.balance = 0; });
            const selectedStrategy = document.querySelector('input[name="strategy"]:checked').value;
            let months = 0;
            let totalInterestPaid = 0;
            let tempPlanDetails = [];
            while (simulationDebts.some(d => d.balance > 0)) {
                months++;
                if (months > 1200) { break; }
                if (months === lumpSumMonth) {
                    let lumpSumRemaining = lumpSum;
                    const lumpSumOrder = [...simulationDebts].sort((a,b) => selectedStrategy === 'snowball' ? a.balance - b.balance : b.apr - a.apr);
                    for(const debt of lumpSumOrder) {
                        if(lumpSumRemaining > 0 && debt.balance > 0) {
                            const payment = Math.min(debt.balance, lumpSumRemaining);
                            debt.balance -= payment;
                            lumpSumRemaining -= payment;
                        }
                    }
                }
                let interestForMonth = 0;
                for (const debt of simulationDebts) {
                    if (debt.balance > 0) {
                        const monthlyInterest = debt.balance * (debt.apr / 100 / 12);
                        interestForMonth += monthlyInterest;
                        debt.balance += monthlyInterest;
                    }
                }
                totalInterestPaid += interestForMonth;
                let paymentsThisMonth = {};
                for(const debt of simulationDebts) { paymentsThisMonth[debt.id] = 0; }
                let minimumsDueThisMonth = 0;
                for (const debt of simulationDebts) {
                    if (debt.balance > 0) {
                        const minPayment = Math.min(debt.balance, debt.minPayment);
                        paymentsThisMonth[debt.id] = minPayment;
                        minimumsDueThisMonth += minPayment;
                    }
                }
                let extraPaymentPool = totalMonthlyPayment - minimumsDueThisMonth;
                const paymentOrder = [...simulationDebts].sort((a, b) => {
                    if (a.balance <= 0) return 1; if (b.balance <= 0) return -1;
                    const aBalanceOwed = a.balance - paymentsThisMonth[a.id];
                    const bBalanceOwed = b.balance - paymentsThisMonth[b.id];
                    if (selectedStrategy === 'snowball') {
                        if (aBalanceOwed === bBalanceOwed) return b.apr - a.apr;
                        return aBalanceOwed - bBalanceOwed;
                    } else {
                        if (b.apr === a.apr) return aBalanceOwed - bBalanceOwed;
                        return b.apr - a.apr;
                    }
                });
                for (const debt of paymentOrder) {
                    if (extraPaymentPool > 0 && debt.balance > 0) {
                        const remainingOwed = debt.balance - paymentsThisMonth[debt.id];
                        const extraPayment = Math.min(remainingOwed, extraPaymentPool);
                        paymentsThisMonth[debt.id] += extraPayment;
                        extraPaymentPool -= extraPayment;
                    }
                }
                const monthBreakdown = { month: months, payments: [], totalInterest: interestForMonth };
                for (const debt of simulationDebts) {
                    const paymentApplied = paymentsThisMonth[debt.id] || 0;
                    debt.balance -= paymentApplied;
                    monthBreakdown.payments.push({ name: debt.name, paymentApplied: paymentApplied, newBalance: debt.balance < 0.005 ? 0 : debt.balance });
                }
                monthBreakdown.remainingBalance = simulationDebts.reduce((sum, d) => sum + d.balance, 0);
                tempPlanDetails.push(monthBreakdown);
            }
            if (isScenario) {
                return { months, totalInterestPaid };
            } else {
                fullPlanDetails = tempPlanDetails;
                displayResults(months, totalInterestPaid);
                renderCharts();
            }
        }
        
        function formatMonthsToYears(totalMonths) {
            const years = Math.floor(totalMonths / 12);
            const months = totalMonths % 12;
            let result = '';
            if (years > 0) { result += `${years} year${years > 1 ? 's' : ''}`; }
            if (months > 0) { if (years > 0) result += ' and '; result += `${months} month${months > 1 ? 's' : ''}`; }
            if (years === 0 && months === 0 && totalMonths > 0) { return `${totalMonths} months`; }
            if (totalMonths === 0) return '0 months';
            return result;
        }

        function runScenario() {
            const extraPayment = parseFloat(document.getElementById('extra-payment').value) || 0;
            const lumpSum = parseFloat(document.getElementById('lump-sum').value) || 0;
            const lumpSumMonth = parseInt(document.getElementById('lump-sum-month').value) || -1;
            if (extraPayment <= 0 && lumpSum <= 0) { alert("Please enter an extra payment or a lump sum to compare."); return; }
            if (lumpSum > 0 && (lumpSumMonth <= 0 || lumpSumMonth > fullPlanDetails.length)) { alert(`Please enter a valid month (between 1 and ${fullPlanDetails.length}) for the lump sum payment.`); return; }
            const scenarioResult = calculatePlan(true, { extraPayment, lumpSum, lumpSumMonth });
            const originalMonths = fullPlanDetails.length;
            const originalInterest = fullPlanDetails.reduce((sum, row) => sum + row.totalInterest, 0);
            const monthsSaved = originalMonths - scenarioResult.months;
            const interestSaved = originalInterest - scenarioResult.totalInterestPaid;
            
            const originalTimeFormatted = formatMonthsToYears(originalMonths);
            const scenarioTimeFormatted = formatMonthsToYears(scenarioResult.months);
            const savingsTimeFormatted = formatMonthsToYears(monthsSaved);

            scenarioResults.style.display = 'block';
            scenarioResults.innerHTML = `<h4>Comparison Results:</h4><table><thead><tr><th>Metric</th><th>Original Plan</th><th>New Scenario</th><th>Savings</th></tr></thead><tbody><tr><td><strong>Debt-Free In</strong></td><td>${originalTimeFormatted}</td><td>${scenarioTimeFormatted}</td><td><strong>${savingsTimeFormatted} sooner</strong></td></tr><tr><td><strong>Total Interest Paid</strong></td><td>$${originalInterest.toFixed(2)}</td><td>$${scenarioResult.totalInterestPaid.toFixed(2)}</td><td><strong>You save $${interestSaved.toFixed(2)}</strong></td></tr></tbody></table>`;
        }
        
        function renderCharts() { dashboardCard.style.display = 'block'; if (!isPro()) { dashboardCard.innerHTML = `<p><strong>Upgrade to Pro to unlock your Visual Dashboard!</strong></p>`; return; } dashboardCard.innerHTML = `<div class="charts-grid"><div class="chart-container"><h3>Debt Breakdown</h3><canvas id="debtPieChart"></canvas></div><div class="chart-container" id="line-chart-container" style="display: none;"><h3>Payoff Projection</h3><canvas id="debtLineChart"></canvas></div></div>`; const pieChartCanvas = document.getElementById('debtPieChart'); const lineChartCanvas = document.getElementById('debtLineChart'); const lineChartContainer = document.getElementById('line-chart-container'); if (pieChartInstance) pieChartInstance.destroy(); if (lineChartInstance) lineChartInstance.destroy(); if (debts.length > 0) { const pieLabels = debts.map(d => d.name); const pieData = debts.map(d => d.balance); pieChartInstance = new Chart(pieChartCanvas, { type: 'pie', data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: ['#007bff', '#dc3545', '#ffc107', '#28a745', '#6f42c1', '#fd7e14', '#20c997'], }] }, options: { responsive: true, maintainAspectRatio: true } }); } if (fullPlanDetails.length > 0) { lineChartContainer.style.display = 'block'; const lineLabels = fullPlanDetails.map(row => `M${row.month}`); lineLabels.unshift("Start"); const lineData = fullPlanDetails.map(row => row.remainingBalance); const startBalance = debts.reduce((sum, d) => sum + d.balance, 0); lineData.unshift(startBalance); lineChartInstance = new Chart(lineChartCanvas, { type: 'line', data: { labels: lineLabels, datasets: [{ label: 'Remaining Balance', data: lineData, borderColor: '#007bff', backgroundColor: 'rgba(0, 123, 255, 0.1)', fill: true, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: true } }); } else { lineChartContainer.style.display = 'none'; } }
        function displayResults(months, totalInterestPaid) { resultsDiv.style.display = 'block'; monthDetailsDiv.style.display = 'none'; const years = Math.floor(months / 12); const remainingMonths = months % 12; resultsSummary.textContent = `You will be debt-free in ${years} years and ${remainingMonths} months! Total interest paid: $${totalInterestPaid.toFixed(2)}.`; planTbody.innerHTML = ''; fullPlanDetails.forEach((row, index) => { const tr = document.createElement('tr'); tr.dataset.index = index; const isPaid = paidMonths.includes(row.month); if(isPaid) tr.classList.add('paid-row'); const actualPaymentThisMonth = row.payments.reduce((sum, p) => sum + p.paymentApplied, 0); let statusCell = `<td></td>`; const buttonText = isPaid ? 'Unmark' : 'Mark Paid'; const buttonClass = isPaid ? 'toggle-paid-btn unmark' : 'toggle-paid-btn'; statusCell = `<td><button class="${buttonClass}" data-month="${row.month}">${buttonText}</button></td>`; tr.innerHTML = `<td>${row.month}</td><td>$${actualPaymentThisMonth.toFixed(2)}</td><td>$${row.totalInterest.toFixed(2)}</td><td>$${row.remainingBalance.toFixed(2)}</td>${statusCell}`; planTbody.appendChild(tr); }); if(isPro()){ scenarioPlanner.style.display = 'block'; scenarioResults.style.display = 'none'; } else { scenarioPlanner.style.display = 'none'; } }
        function handlePlanClick(event) { if (event.target.classList.contains('toggle-paid-btn')) { event.stopPropagation(); const month = parseInt(event.target.dataset.month); toggleMonthPaid(month, true); return; } const row = event.target.closest('tr'); if (!row) return; const monthIndex = parseInt(row.dataset.index); const monthData = fullPlanDetails[monthIndex]; displayMonthDetails(monthData); }
        function toggleMonthPaid(month, isUserAction = false) { const index = paidMonths.indexOf(month); const monthData = fullPlanDetails.find(row => row.month === month); if (!monthData) return; const activePayments = monthData.payments.filter(p => p.paymentApplied > 0.005).map(p => p.name); if (index > -1) { if (isUserAction) { paidProgress[month] = []; } paidMonths.splice(index, 1); } else { if (isUserAction) { paidProgress[month] = activePayments; } paidMonths.push(month); } localStorage.setItem('paidMonths', JSON.stringify(paidMonths)); localStorage.setItem('paidProgress', JSON.stringify(paidProgress)); const totalInterest = fullPlanDetails.reduce((sum, row) => sum + row.totalInterest, 0); displayResults(fullPlanDetails.length, totalInterest); }
        function handlePaymentCheck(event) { if (event.target.type !== 'checkbox') return; const month = parseInt(event.target.dataset.month); const debtName = event.target.dataset.debtName; if (!paidProgress[month]) { paidProgress[month] = []; } const index = paidProgress[month].indexOf(debtName); if (event.target.checked) { if (index === -1) paidProgress[month].push(debtName); } else { if (index > -1) paidProgress[month].splice(index, 1); } localStorage.setItem('paidProgress', JSON.stringify(paidProgress)); const monthData = fullPlanDetails.find(row => row.month === month); const activePaymentsInMonth = monthData.payments.filter(p => p.paymentApplied > 0.005); if (paidProgress[month].length === activePaymentsInMonth.length) { if (!paidMonths.includes(month)) { toggleMonthPaid(month); } } else { if (paidMonths.includes(month)) { toggleMonthPaid(month); } } }
        function displayMonthDetails(monthData) { monthDetailsDiv.style.display = 'block'; let detailsHtml = `<h4>Details for Month ${monthData.month}</h4><ul>`; monthData.payments.forEach(p => { if (p.paymentApplied > 0.005) { const paidInMonth = paidProgress[monthData.month] || []; const isChecked = paidInMonth.includes(p.name); detailsHtml += `<li><input type="checkbox" id="payment-${monthData.month}-${p.name}" data-month="${monthData.month}" data-debt-name="${p.name}" ${isChecked ? 'checked' : ''}><label for="payment-${monthData.month}-${p.name}"><strong>${p.name}:</strong> Pay $${p.paymentApplied.toFixed(2)} (New Balance: $${p.newBalance.toFixed(2)})</label></li>`; } }); detailsHtml += `</ul>`; monthDetailsDiv.innerHTML = detailsHtml; monthDetailsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
        function saveAndRender() { saveDebts(); renderDebts(); updateGuidance(); initializeState(); }
        function renderDebts() {
            debtList.innerHTML = '';
            debts.forEach(debt => {
                const listItem = document.createElement('li');
                listItem.classList.add('debt-item');
                listItem.dataset.id = debt.id;
                const isPaid = paidDebtIds.includes(debt.id);
                if (isPaid) { listItem.classList.add('paid'); }
                const checkmark = `<span class="mark-paid-btn" title="Mark as Paid Off">✓</span>`;
                listItem.innerHTML = `<div style="display: flex; align-items: center;">${checkmark}<div class="debt-details"><strong>${debt.name}</strong>${isPaid ? '<span class="paid-badge">PAID!</span>' : ''}<br><small>$${debt.balance.toFixed(2)} @ ${debt.apr}% APR (Min: $${debt.minPayment.toFixed(2)})</small></div></div><div class="debt-actions"><button class="edit-btn">Edit</button><button class="delete-btn">Delete</button></div>`;
                debtList.appendChild(listItem);
            });
        }
        function saveDebts() { localStorage.setItem('debts', JSON.stringify(debts)); }
        function updateGuidance() { const totalMinimums = debts.reduce((sum, debt) => sum + debt.minPayment, 0); if (totalMinimums > 0) { minPaymentGuidance.textContent = `Your total minimum payment is $${totalMinimums.toFixed(2)}. Pay more to get out of debt faster!`; } else { minPaymentGuidance.textContent = 'Enter your debts to see your minimum monthly payment.'; } }
        function initializeState() { const savedBudget = localStorage.getItem('monthlyBudget'); if (savedBudget) { totalPaymentInput.value = savedBudget; } updateUIForProStatus(); if (savedBudget && debts.length > 0) { calculatePlan(); } }
        
        saveAndRender();
    });
    </script>
</body>
</html>

